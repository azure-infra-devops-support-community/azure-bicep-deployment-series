pr: none
trigger:
  batch: false
  branches:
    include:
    - main
  paths:
    include:
    - AzureDevOps/Bicep/*

# variables:
#   major: 1
#   minor: 0
#   patch: $[counter(format('{0}.{1}-{2}', variables['major'], variables['minor'], variables['Build.SourceBranchName']), 1)]
#   ${{ if eq( variables['Build.SourceBranchName'], 'main' ) }}: 
#     branch: ''
#   ${{ if ne( variables['Build.SourceBranchName'], 'main' ) }}: 
#     branch: -${{ variables['Build.SourceBranchName'] }}

# variables:
# ### Pipeline variables
#   serviceConnectionName: eng-engineering
#   templateFile: $(Build.Repository.LocalPath)/Bicep/main.bicep
#   parametersFile: $(Build.Repository.LocalPath)/Bicep/dev.parameter.bicepparam
#   DeploymentName: selfhostedagent
#   subscriptionId: 800eeb5c-ab87-468f-800b-d9ca632b4f73

# name: $(major).$(minor).$(patch)$(branch)-Infrastructure

pool:
  name: linux-agentpool

stages:
### Testing Stage
- stage: testing
  displayName: Testing
  jobs:
  - job: List_Directory
    displayName: 'List Directory'
    steps:
    - script: |
        echo "Listing the directory structure:"
        ls -R
        cat Bicep/main.bicep
        cat Bicep/env/dev.parameter.bicepparam
        az bicep build --file ${{ variables.bicepFolder }}/main.bicep
        jq . ${{ variables.bicepFolder }}/dev.parameter.bicepparam
      displayName: 'List all files and directories recursively'

# stages:
# ### Validate & Publish
# - template: ../Templates/Stages/stage-validate-publish-bicep.yml
#   parameters:
#     name: Validate_Publish
#     displayName: Validate & Publish
#     variables:
#     - template: ../Variables/variables-dev.yml


# ### Validate
# - template: ../Templates/Stages/bicep-validation-stage.yml
#   parameters:
#     name: Validate
#     displayName: Validate
#     variables:
#     ### Pipeline variables
#       serviceConnectionName: eng-engineering
#       templateFile: Bicep/main.bicep
#       parametersFile: Bicep/env/dev.parameter.bicepparam
#       DeploymentName: selfhostedagent
#       subscriptionId: 800eeb5c-ab87-468f-800b-d9ca632b4f73
#     # variables:
#     # - template: ../Templates/Variables/variables-dev.yml

# ### Lint
# - template: ../Templates/Stages/bicep-lint-stage.yml
#   parameters:
#     name: Lint
#     displayName: Lint
#     dependsOn: Validate
#     variables:
#     - template: ../Templates/Variables/variables-dev.yml

# ### Manual Deployment approval
# - template: ../Templates/Stages/manual-approval-stage.yml
#   parameters:
#     name: ManualApproval
#     displayName: ManualApproval
#     dependsOn: Lint
#     variables:
#     - template: ../Templates/Variables/variables-dev.yml

# ### Deploy Infrastructure BVT
# - template: ../Templates/Stages/bicep-deployment-stage.yml
#   parameters:
#     name: Deploy_Infrastructure_BVT
#     displayName: Deploy Infrastructure BVT
#     dependsOn: ManualApproval
#     variables:
#     - template: ../Templates/Variables/variables-dev.yml
#     environment: BVT
