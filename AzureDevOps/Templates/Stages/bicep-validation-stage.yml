parameters:
- name: name
  displayName: Stage Name
  type: string

- name: displayName
  displayName: Stage Display Name
  type: string

- name: dependsOn
  displayName: Depends On
  type: object
  default: ''

- name: condition
  displayName: Condition
  type: string
  default: ''

- name: variables
  displayName: Variables
  type: object
  default: ''

stages:
- stage: ${{ parameters.name }}
  displayName: ${{ parameters.displayName }}
  ${{ if not(eq(parameters.dependsOn, '')) }}:
    dependsOn: ${{ parameters.dependsOn }}
  ${{ if not(eq(parameters.condition, '')) }}:
    condition: ${{ parameters.condition }}
  ${{ if not(eq(parameters.variables, '')) }}:
    variables: ${{ parameters.variables }}
  jobs:
  - job: Validate_Lint_Bicep_Files
    displayName: Validate & Lint Bicep Files
    steps: 
    # Validate Bicep parameter file is valid bicepparam
    - task: CmdLine@2
      name: Validate_Bicep_Parameters_File
      displayName: Validate Bicep Parameters File
      inputs:
        script: az bicep build-params --file ${{ variables.parametersFile }} --stdout

    # Validate and Format Bicep file 
    - task: CmdLine@2
      name: Format_Validate_Bicep
      displayName: Format Validate Bicep
      inputs:
        script: |
          az bicep format --file ${{ variables.templateFile }}
          az bicep build --file ${{ variables.templateFile }} --stdout
        failOnStderr: true

    # Lint Bicep file
    - task: CmdLine@2
      name: Lint_Bicep
      displayName: Lint Bicep
      inputs:
        script: |
          az bicep lint --file ${{ variables.templateFile }} --diagnostics-format sarif  > $(System.DefaultWorkingDirectory)/bicep-lint.sarif
        failOnStderr: true

    # Publish Linting Report
    - task: PublishBuildArtifacts@1
      condition: always()
      inputs:
        pathToPublish: $(System.DefaultWorkingDirectory)/bicep.sarif
        artifactName: CodeAnalysisLogs # required to show up in the scans tab